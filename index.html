<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫教會會議紀錄查詢</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* 淺灰色背景 */
        }
        /* 自定義滾動條樣式 */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 關鍵字高亮樣式 */
        .highlight {
            background-color: #fde68a; /* 淺黃色背景 */
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }
        /* 登入視窗背景 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999; /* 確保在最上層 */
        }
        /* 登入視窗內容 */
        .modal-content {
            z-index: 1000; /* 確保在最上層 */
        }
        /* 區塊內容隱藏/顯示動畫 */
        .section-content {
            max-height: 0; /* 預設收合 */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out; /* 調整過渡時間 */
        }
        .section-content.expanded { /* 展開時使用這個類別 */
            max-height: 9999px; /* 足夠大的值以顯示內容 */
        }
        /* 箭頭旋轉 */
        .arrow-icon {
            transition: transform 0.3s ease;
            transform: rotate(0deg); /* 預設收合，箭頭向右 */
        }
        .arrow-icon.expanded { /* 展開時使用這個類別 */
            transform: rotate(90deg); /* 展開時箭頭向下 */
        }

        /* 文件預覽模態視窗樣式 */
        #documentViewerModal {
            display: none; /* 預設隱藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #documentViewerModal.flex {
            display: flex; /* 顯示時變為 flex */
        }
        .document-viewer-content {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            height: 90%;
            max-width: 1000px; /* 最大寬度 */
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .document-viewer-iframe {
            flex-grow: 1; /* 讓 iframe 佔滿剩餘空間 */
            border: none;
            width: 100%;
            height: 100%;
        }
.document-viewer-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #4b5563; /* gray-600 */
}

        .level-1 {
            margin-left: 0em;
            text-indent: 0em;
        }
        .level-2 {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }
        .level-3 {
            margin-left: 3em;
            text-indent: -3em;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <!-- 新增會議內容按鈕 (固定在右上角) -->
    <a id="addMeetingButton"
       class="fixed top-4 right-4 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out text-base z-50 cursor-pointer">
        新增會議內容
    </a>

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-5xl border border-gray-200 mb-8 mt-16 md:mt-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">醫學教育委員會會議紀錄查詢</h1>

        <section id="monthQuickNav" class="mb-6 bg-slate-50 border border-slate-200 rounded-xl p-4 shadow-sm">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <p class="text-xs tracking-wider text-slate-500 uppercase">快速月份導覽</p>
                    <p id="monthQuickNavYear" class="text-lg font-semibold text-slate-700 mt-1">114 年快速導覽</p>
                </div>
                <div id="monthQuickNavButtons" class="grid w-full grid-cols-3 gap-2 sm:w-auto sm:grid-cols-6 md:grid-cols-9"></div>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <input type="text" id="keywordInput" placeholder="輸入關鍵字查詢 (例如: 報告, 臨時動議)"
                   class="col-span-1 md:col-span-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">

            <div class="flex flex-col sm:flex-row gap-4 col-span-1 md:col-span-2">
                <input type="date" id="startDateInput"
                       class="flex-grow px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <input type="date" id="endDateInput"
                       class="flex-grow px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div class="flex flex-col sm:flex-row gap-4 col-span-1 md:col-span-1">
                <button id="searchButton"
                        class="flex-grow px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    搜尋會議
                </button>
                <button id="showAllButton"
                        class="flex-grow px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    顯示所有會議
                </button>
            </div>
        </div>

        <!-- 訊息顯示區塊 -->
        <div id="messageContainer" class="mt-4 p-4 rounded-md hidden">
            <p id="messageText" class="text-center"></p>
        </div>
    </div>

    <div id="resultsContainer" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-5xl border border-gray-200 flex-grow scrollable-content overflow-y-auto">
        <p class="text-gray-500 text-center" id="initialMessage">請輸入關鍵字、選擇日期區間或點擊「顯示所有會議」來查詢。</p>
        <!-- 查詢結果將顯示在這裡 -->
    </div>

    <!-- 登入視窗 -->
    <div id="loginModal" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm modal-content relative">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">管理員登入</h2>
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">帳號</label>
                <input type="text" id="username" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                <input type="password" id="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <p id="loginMessage" class="text-red-600 text-sm mb-4 hidden text-center"></p>
            <div class="flex justify-end gap-3">
                <button id="cancelLoginButton"
                        class="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    取消
                </button>
                <button id="loginButton"
                        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    登入
                </button>
            </div>
        </div>
    </div>

    <!-- 文件預覽模態視窗 -->
    <div id="documentViewerModal" class="flex-col">
        <div class="document-viewer-content">
            <button class="document-viewer-close" id="closeDocumentViewer">&times;</button>
            <iframe id="documentViewerIframe" class="document-viewer-iframe"></iframe>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 查詢功能相關元素
            const keywordInput = document.getElementById('keywordInput');
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            const searchButton = document.getElementById('searchButton');
            const showAllButton = document.getElementById('showAllButton');
            const resultsContainer = document.getElementById('resultsContainer');
            const messageContainer = document.getElementById('messageContainer');
            const messageText = document.getElementById('messageText');
            const initialMessage = document.getElementById('initialMessage');
            const monthQuickNavYearLabel = document.getElementById('monthQuickNavYear');
            const monthQuickNavButtons = document.getElementById('monthQuickNavButtons');
            const monthButtonBaseClasses = 'flex cursor-pointer flex-col items-center justify-center gap-1 rounded-lg border border-slate-200 bg-white px-3 py-2 text-center text-slate-600 shadow-sm transition hover:-translate-y-0.5 hover:border-sky-300 hover:bg-sky-50 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-60';
            let currentNavYear = getDefaultRocYear();

            createMonthButtons(currentNavYear);
            updateMonthNav(currentNavYear, new Set());

            // 登入功能相關元素
            const addMeetingButton = document.getElementById('addMeetingButton');
            const loginModal = document.getElementById('loginModal');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginButton = document.getElementById('loginButton');
            const cancelLoginButton = document.getElementById('cancelLoginButton');
            const loginMessage = document.getElementById('loginMessage');

            // 文件預覽模態視窗元素
            const documentViewerModal = document.getElementById('documentViewerModal');
            const documentViewerIframe = document.getElementById('documentViewerIframe');
            const closeDocumentViewerButton = document.getElementById('closeDocumentViewer');


            // Apps Script Web 應用程式 URL
            const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxgkjyZdtiSBDMuHtuwJweCeyxXVzGnn8VtwnvhXwyQMcPthHpdtoAIZgeeAWixJICm/exec';
            // 會議內容輸入頁面的 URL (請確保此檔案存在且名稱正確)
            const MEETING_INPUT_PAGE_URL = 'meeting-record-form.html';

            // --- 查詢功能相關邏輯 ---

            // 顯示訊息的輔助函數
            function showMessage(text, type = 'info') {
                messageText.textContent = text;
                messageContainer.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
                if (type === 'success') {
                    messageContainer.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    messageContainer.classList.add('bg-red-100', 'text-red-800');
                } else { // info or loading
                    messageContainer.classList.add('bg-blue-100', 'text-blue-800');
                }
                messageContainer.classList.remove('hidden');
                // 3秒後隱藏訊息
                setTimeout(() => {
                    messageContainer.classList.add('hidden');
                }, 3000);
            }

            // 關鍵字高亮函數
            function highlightKeyword(text, keyword) {
                if (!keyword || !text) return text;
                const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escapedKeyword, 'gi');
                return text.replace(regex, match => `<span class="highlight">${match}</span>`);
            }

            function getDefaultRocYear() {
                const now = new Date();
                const rocYear = now.getFullYear() - 1911;
                return rocYear > 0 ? rocYear : now.getFullYear();
            }

            function createMonthButtons(year) {
                if (!monthQuickNavButtons) return;
                monthQuickNavButtons.innerHTML = '';
                const months = Array.from({ length: 9 }, (_, index) => 9 - index);
                months.forEach(month => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.month = String(month).padStart(2, '0');
                    button.className = monthButtonBaseClasses;
                    button.innerHTML = `
                        <span class="block text-xs text-slate-500" data-role="year-label">${year} 年</span>
                        <span class="block text-sm font-semibold text-slate-700">${month} 月</span>
                    `;
                    button.addEventListener('click', () => {
                        if (button.disabled) return;
                        const target = document.getElementById(`month-${button.dataset.month}`);
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            showMessage('目前查詢結果中尚未有該月份的會議紀錄。', 'info');
                        }
                    });
                    monthQuickNavButtons.appendChild(button);
                });
            }

            function updateMonthNav(year, availableMonths = new Set()) {
                if (!monthQuickNavButtons || !monthQuickNavYearLabel) return;
                const yearToDisplay = year || getDefaultRocYear();
                currentNavYear = yearToDisplay;
                monthQuickNavYearLabel.textContent = `${yearToDisplay} 年快速導覽`;
                monthQuickNavButtons.querySelectorAll('button').forEach(button => {
                    const isAvailable = availableMonths.has(button.dataset.month);
                    button.disabled = !isAvailable;
                    const yearLabel = button.querySelector('[data-role="year-label"]');
                    if (yearLabel) {
                        yearLabel.textContent = `${yearToDisplay} 年`;
                    }
                });
            }

            function toRocYear(date) {
                if (!(date instanceof Date) || isNaN(date.getTime())) return null;
                const rocYear = date.getFullYear() - 1911;
                return rocYear > 0 ? rocYear : null;
            }

            function parseMeetingDate(rawDate) {
                if (!rawDate) return null;
                if (rawDate instanceof Date) {
                    return isNaN(rawDate.getTime()) ? null : rawDate;
                }

                const normalized = rawDate
                    .toString()
                    .trim()
                    .replace(/[年月]/g, '/')
                    .replace(/日/g, '')
                    .replace(/-/g, '/')
                    .replace(/\./g, '/');

                const parts = normalized.split(/[\/]/).filter(Boolean);
                if (parts.length >= 3) {
                    let year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10);
                    const day = parseInt(parts[2], 10);

                    if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                        if (year < 1911) {
                            year += 1911;
                        }
                        const parsedDate = new Date(year, month - 1, day);
                        if (!isNaN(parsedDate.getTime())) {
                            return parsedDate;
                        }
                    }
                }

                const fallbackDate = new Date(rawDate);
                return isNaN(fallbackDate.getTime()) ? null : fallbackDate;
            }

            // 格式化日期為 YYYY-MM-DD
            function formatDate(dateString) {
                if (!dateString) return '無';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return dateString;
                    }
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    console.error("Error formatting date:", e);
                    return dateString;
                }
            }

            // 格式化時間為 HH:MM
            function formatTime(timeString) {
                if (!timeString) return '無';
                try {
                    const timeMatch = timeString.match(/(\d{1,2}:\d{2})/);
                    if (timeMatch && timeMatch[1]) {
                        return timeMatch[1];
                    }
                    const date = new Date(`2000-01-01T${timeString}`);
                    if (!isNaN(date.getTime())) {
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return `${hours}:${minutes}`;
                    }
                    return timeString;
                } catch (e) {
                    console.error("Error formatting time:", e);
                    return timeString;
                }
            }

            // 格式化建立時間為 YYYY-MM-DD HH:MM
            function formatCreationTime(dateTimeString) {
                if (!dateTimeString) return '無';
                try {
                    const date = new Date(dateTimeString);
                    if (isNaN(date.getTime())) {
                        return dateTimeString;
                    }
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day} ${hours}:${minutes}`;
                } catch (e) {
                    console.error("Error formatting creation time:", e);
                    return dateTimeString;
                }
            }

            // 將文本中的 URL 轉換為可點擊的按鈕
             function formatAttachmentLinks(text, keyword) {
                if (!text) return '';
                const lines = text.split('\n').filter(line => line.trim() !== '');
                let html = '';
                lines.forEach((line) => {
                    const urlMatch = line.match(/(https?:\/\/[^\s]+)/);
                    const url = urlMatch ? urlMatch[0] : '';
                    
                    if (url) {
                        const descriptionMatch = line.match(/^(.*?):/);
                        const description = descriptionMatch ? descriptionMatch[1].trim() : '';
                        const displayTitle = description || '附件點選';
                        
                        const isRelevant = keyword ? (description + url).toLowerCase().includes(keyword.toLowerCase()) : true;
                        
                        if (isRelevant) {
                            html += `
                                <div class="mt-2 bg-gray-100 p-3 rounded-md border border-gray-100">
                                    <button type="button" class="text-blue-600 hover:underline font-medium w-full text-left" data-url="${url}" onclick="openDocumentViewer(this.dataset.url)">
                                        ${highlightKeyword(displayTitle, keyword)}
                                    </button>
                                </div>
                            `;
                        }
                    } else {
                        if (keyword ? line.toLowerCase().includes(keyword.toLowerCase()) : true) {
                            html += `<p class="mt-2 text-gray-600">${highlightKeyword(line, keyword)}</p>`;
                        }
                    }
                });
                  return html;
              }

              // 根據行首字元判斷層級並套用對應樣式
              function formatLines(text, keyword) {
                  if (!text) return '';
                  return text.split('\n').map(line => {
                      if (line.trim() === '') return '';
                      const trimmed = line.trim();
                      let levelClass = '';
                      if (/^[一二三四五六七八九十]+、/.test(trimmed)) {
                          levelClass = 'level-1';
                      } else if (/^\d+\./.test(trimmed)) {
                          levelClass = 'level-2';
                      } else if (/^\(\d+\)/.test(trimmed)) {
                          levelClass = 'level-3';
                      }
                      const classAttr = levelClass ? ` class="${levelClass}"` : '';
                      return `<p${classAttr}>${highlightKeyword(line, keyword)}</p>`;
                  }).join('');
              }

            // 檢查會議紀錄或其內容是否包含關鍵字
            function containsKeyword(data, keyword) {
                if (!keyword) return true;
                const lowerKeyword = keyword.toLowerCase();

                for (const key in data) {
                    if (typeof data[key] === 'string' && data[key].toLowerCase().includes(lowerKeyword)) {
                        return true;
                    }
                }

                const meetingSectionsFields = [
                    '壹、頒獎表揚', '貳、主席報告', '參、上次會議追蹤事項',
                    '肆、本次會議報告及討論事項', '伍、臨時動議', '陸、下次會議追蹤事項', '柒、主席結論', '附件名稱'
                ];
                for (const field of meetingSectionsFields) {
                    if (data[field] && data[field].toLowerCase().includes(lowerKeyword)) {
                        return true;
                    }
                }
                return false;
            }

            // 執行查詢的函數
            async function performSearch(keyword = '', startDate = '', endDate = '', showLatest = false) {
                let lowerKeyword = keyword.toLowerCase();
                if (!keyword) {
                    lowerKeyword = '';
                }

                initialMessage.classList.add('hidden');
                resultsContainer.innerHTML = '';
                showMessage('正在查詢會議內容，請稍候...', 'info');

                try {
                    let url = `${APPS_SCRIPT_WEB_APP_URL}?`;
                    const params = [];
                    if (keyword) params.push(`keyword=${encodeURIComponent(keyword)}`);
                    if (startDate) params.push(`startDate=${encodeURIComponent(startDate)}`);
                    if (endDate) params.push(`endDate=${encodeURIComponent(endDate)}`);
                    if (showLatest) params.push(`showLatest=${showLatest}`);
                    url += params.join('&');

                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        if (result.data && result.data.length > 0) {
                            resultsContainer.innerHTML = '';
                            const sortedData = [...result.data].sort((a, b) => {
                                const dateA = parseMeetingDate(a['會議日期']);
                                const dateB = parseMeetingDate(b['會議日期']);
                                if (dateA && dateB) {
                                    return dateB - dateA;
                                }
                                if (dateA) return -1;
                                if (dateB) return 1;
                                return 0;
                            });
                            let displayedMeetingsCount = 0;
                            let highestRocYear = null;
                            const monthsByYear = new Map();
                            const meetingCards = [];

                            sortedData.forEach(meeting => {
                                // 判斷是否需要顯示該會議卡片
                                const shouldDisplayCard = keyword || startDate || endDate;

                                // 如果是關鍵字或日期查詢，且不包含關鍵字，則跳過此會議紀錄
                                if (shouldDisplayCard && !containsKeyword(meeting, keyword)) {
                                    return;
                                }

                                displayedMeetingsCount++;

                                const meetingDate = parseMeetingDate(meeting['會議日期']);
                                const meetingMonth = meetingDate ? String(meetingDate.getMonth() + 1).padStart(2, '0') : null;
                                const meetingRocYear = meetingDate ? toRocYear(meetingDate) : null;

                                if (meetingRocYear !== null) {
                                    if (!monthsByYear.has(meetingRocYear)) {
                                        monthsByYear.set(meetingRocYear, new Set());
                                    }
                                    if (meetingMonth) {
                                        monthsByYear.get(meetingRocYear).add(meetingMonth);
                                    }
                                    if (highestRocYear === null || meetingRocYear > highestRocYear) {
                                        highestRocYear = meetingRocYear;
                                    }
                                }

                                const meetingCard = document.createElement('div');
                                meetingCard.className = 'bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-100 mb-4';

                                let cardHtml = `
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-xl font-semibold text-gray-800">${highlightKeyword(meeting['會議名稱'] || '無會議名稱', keyword)}</h3>
                                        <button class="edit-button px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg shadow-sm hover:bg-gray-400 transition-colors duration-150 ease-in-out" data-row-index="${meeting.rowIndex}">編輯</button>
                                    </div>
                                    <p class="text-gray-600 mb-1"><strong>日期:</strong> ${highlightKeyword(formatDate(meeting['會議日期']), keyword)}</p>
                                    <p class="text-gray-600 mb-1"><strong>時間:</strong> ${highlightKeyword(formatTime(meeting['開始時間']), keyword)} - ${highlightKeyword(formatTime(meeting['結束時間']), keyword)}</p>
                                    <p class="text-gray-600 mb-1"><strong>地點:</strong> ${highlightKeyword(meeting['會議地點'] || '無', keyword)}</p>
                                    <p class="text-gray-600 mb-1"><strong>主席:</strong> ${highlightKeyword(meeting['主席'] || '無', keyword)}</p>
                                `;

                                const meetingSections = [
                                    { title: '壹、頒獎表揚', field: '壹、頒獎表揚' },
                                    { title: '貳、主席報告', field: '貳、主席報告' },
                                    { title: '參、上次會議追蹤事項', field: '參、上次會議追蹤事項' },
                                    { title: '肆、本次會議報告及討論事項', field: '肆、本次會議報告及討論事項' },
                                    { title: '伍、臨時動議', field: '伍、臨時動議' },
                                    { title: '陸、下次會議追蹤事項', field: '陸、下次會議追蹤事項' },
                                    { title: '柒、主席結論', field: '柒、主席結論' }
                                ];

                                meetingSections.forEach(section => {
                                    const content = meeting[section.field] || '';
                                    const lowerContent = content.toLowerCase();

                                    const isSectionContentRelevant = keyword ? lowerContent.includes(lowerKeyword) : false;
                                    
                                    // 判斷是否需要展開：有關鍵字，或有日期範圍，或無搜尋條件時
                                    const shouldExpand = keyword || (startDate && endDate) || showLatest;

                                    // 確保只有有內容的區塊才生成
                                    if (content.trim() !== '') {
                                        const sectionExpandedClass = shouldExpand ? 'expanded' : '';
                                        const sectionArrowClass = shouldExpand ? 'expanded' : '';

                                        if (section.field === '肆、本次會議報告及討論事項') {
                                            let subSectionsHtml = '';
                                            const subSectionsRegex = /([一二三四五六七八九十\d]+[、．][\s\S]*?(?=\n[一二三四五六七八九十\d]+[、．]|$))/g;
                                            let match;
                                            let lastIndex = 0;

                                             const preContent = content.substring(0, content.search(subSectionsRegex)).trim();
                                             if (preContent && (keyword ? preContent.toLowerCase().includes(lowerKeyword) : true)) {
                                                 subSectionsHtml += formatLines(preContent, keyword);
                                             }
                                             subSectionsRegex.lastIndex = 0;

                                            while ((match = subSectionsRegex.exec(content)) !== null) {
                                                const fullSubSectionText = match[0].trim();
                                                const isSubSectionRelevant = keyword ? fullSubSectionText.toLowerCase().includes(lowerKeyword) : false;

                                                const subSectionExpandedClass = isSubSectionRelevant || shouldExpand ? 'expanded' : '';
                                                const subSectionArrowClass = isSubSectionRelevant || shouldExpand ? 'expanded' : '';

                                                const subSectionTitleMatch = fullSubSectionText.match(/^([一二三四五六七八九十\d]+[、．][^：]*[：]?)/);
                                                const subSectionTitle = subSectionTitleMatch ? subSectionTitleMatch[0].trim() : '';
                                                const subSectionBody = subSectionTitleMatch ? fullSubSectionText.substring(subSectionTitle.length).trim() : fullSubSectionText;

                                                const subSectionId = `${section.field.replace(/[^a-zA-Z0-9]/g, '')}_${subSectionsRegex.lastIndex}`;

                                                 const formattedSubSectionBody = formatLines(subSectionBody, keyword);

                                                subSectionsHtml += `
                                                    <div class="mt-2 bg-gray-100 p-3 rounded-md border border-gray-100">
                                                        <div class="flex justify-between items-center cursor-pointer section-header" data-target="${subSectionId}">
                                                            <h5 class="text-base font-semibold text-gray-700">${highlightKeyword(subSectionTitle, keyword)}</h5>
                                                            <svg class="arrow-icon w-4 h-4 text-gray-500 ${subSectionArrowClass}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                                            </svg>
                                                        </div>
                                                        <div id="${subSectionId}" class="section-content mt-1 text-gray-600 text-sm ${subSectionExpandedClass}">
                                                            ${formattedSubSectionBody}
                                                        </div>
                                                    </div>
                                                `;
                                                lastIndex = subSectionsRegex.lastIndex;
                                            }

                                             const remainingContent = content.substring(lastIndex).trim();
                                             if (remainingContent && (keyword ? remainingContent.toLowerCase().includes(lowerKeyword) : true)) {
                                                 subSectionsHtml += formatLines(remainingContent, keyword);
                                             }

                                            cardHtml += `
                                                <div class="mt-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                                    <div class="flex justify-between items-center cursor-pointer section-header" data-target="${section.field.replace(/[^a-zA-Z0-9]/g, '')}">
                                                        <h4 class="text-lg font-semibold text-gray-800">${section.title}</h4>
                                                        <svg class="arrow-icon w-5 h-5 text-gray-600 ${sectionArrowClass}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                                        </svg>
                                                    </div>
                                                    <div id="${section.field.replace(/[^a-zA-Z0-9]/g, '')}" class="section-content mt-2 text-gray-700 text-sm ${sectionExpandedClass}">
                                                        ${subSectionsHtml}
                                                    </div>
                                                </div>
                                            `;

                                        } else {
                                             const sectionContentHtml = formatLines(content, keyword);

                                            cardHtml += `
                                                <div class="mt-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                                    <div class="flex justify-between items-center cursor-pointer section-header" data-target="${section.field.replace(/[^a-zA-Z0-9]/g, '')}">
                                                        <h4 class="text-lg font-semibold text-gray-800">${section.title}</h4>
                                                        <svg class="arrow-icon w-5 h-5 text-gray-600 ${sectionArrowClass}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                                        </svg>
                                                    </div>
                                                    <div id="${section.field.replace(/[^a-zA-Z0-9]/g, '')}" class="section-content mt-2 text-gray-700 text-sm ${sectionExpandedClass}">
                                                        ${sectionContentHtml}
                                                    </div>
                                                </div>
                                            `;
                                        }
                                    }
                                });

                                // 附件部分作為獨立卡片處理
                                const attachmentContent = meeting['附件名稱'] || '';
                                const lowerAttachmentContent = attachmentContent.toLowerCase();
                                const isAttachmentRelevant = keyword ? lowerAttachmentContent.includes(lowerKeyword) : false;

                                if (attachmentContent.trim() !== '' && (isAttachmentRelevant || !keyword)) {
                                    const attachmentExpandedClass = isAttachmentRelevant || (showLatest && !keyword) || (startDate || endDate) ? 'expanded' : '';
                                    const attachmentArrowClass = isAttachmentRelevant || (showLatest && !keyword) || (startDate || endDate) ? 'expanded' : '';
                                    const attachmentSectionId = '附件';

                                    const attachments = attachmentContent.split('\n').filter(line => line.trim() !== '');
                                    let attachmentLinksHtml = '';

                                    attachments.forEach((attachmentLine) => {
                                        const urlMatch = attachmentLine.match(/(https?:\/\/[^\s]+)/);
                                        const url = urlMatch ? urlMatch[0] : '';
                                        const descriptionMatch = attachmentLine.match(/^(.*?):/);
                                        const description = descriptionMatch ? descriptionMatch[1].trim() : '';

                                        const displayTitle = (!description || description.toLowerCase().startsWith('http')) ? '附件查閱' : description;

                                        if (url) {
                                            const isLinkRelevant = keyword ? (description + url).toLowerCase().includes(lowerKeyword) : true;
                                            if (isLinkRelevant) {
                                                attachmentLinksHtml += `
                                                    <div class="mt-2 bg-gray-100 p-3 rounded-md border border-gray-100">
                                                        <button type="button" class="text-blue-600 hover:underline font-medium w-full text-left" data-url="${url}" onclick="openDocumentViewer(this.dataset.url)">
                                                            ${highlightKeyword(displayTitle, keyword)}
                                                        </button>
                                                    </div>
                                                `;
                                            }
                                        } else {
                                            if (keyword ? attachmentLine.toLowerCase().includes(lowerKeyword) : true) {
                                                attachmentLinksHtml += `<p class="mt-2 text-gray-600">${highlightKeyword(attachmentLine, keyword)}</p>`;
                                            }
                                        }
                                    });

                                    if (attachmentLinksHtml) {
                                        cardHtml += `
                                            <div class="mt-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                                <div class="flex justify-between items-center cursor-pointer section-header" data-target="${attachmentSectionId}">
                                                    <h4 class="text-lg font-semibold text-gray-800">附件</h4>
                                                    <svg class="arrow-icon w-5 h-5 text-gray-600 ${attachmentArrowClass}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                                    </svg>
                                                </div>
                                                <div id="${attachmentSectionId}" class="section-content mt-2 text-gray-700 text-sm ${attachmentExpandedClass}">
                                                    ${attachmentLinksHtml}
                                                </div>
                                            </div>
                                        `;
                                    }
                                }

                                cardHtml += `
                                    <p class="text-gray-500 text-sm mt-4"><strong>建立時間:</strong> ${highlightKeyword(formatCreationTime(meeting['建立時間']), keyword)}</p>
                                `;
                                meetingCard.innerHTML = cardHtml;
                                meetingCards.push({
                                    element: meetingCard,
                                    month: meetingMonth,
                                    rocYear: meetingRocYear
                                });
                            });

                            const targetYear = highestRocYear !== null ? highestRocYear : currentNavYear;
                            const availableMonths = monthsByYear.get(targetYear) || new Set();
                            const monthAnchors = new Set();

                            meetingCards.forEach(({ element, month, rocYear }) => {
                                if (rocYear === targetYear && month && !monthAnchors.has(month)) {
                                    const anchor = document.createElement('div');
                                    anchor.id = `month-${month}`;
                                    anchor.className = 'block h-0 scroll-mt-24';
                                    resultsContainer.appendChild(anchor);
                                    monthAnchors.add(month);
                                }
                                resultsContainer.appendChild(element);
                            });

                            if (displayedMeetingsCount > 0) {
                                updateMonthNav(targetYear, availableMonths);
                            } else {
                                updateMonthNav(currentNavYear, new Set());
                            }

                            resultsContainer.querySelectorAll('.section-header').forEach(header => {
                                header.addEventListener('click', (event) => {
                                    if (event.target.tagName === 'BUTTON' && event.target.classList.contains('view-document-button')) {
                                        return;
                                    }
                                    const targetId = header.dataset.target;
                                    const contentDiv = document.getElementById(targetId);
                                    const arrowIcon = header.querySelector('.arrow-icon');

                                    if (contentDiv) {
                                        contentDiv.classList.toggle('expanded');
                                        arrowIcon.classList.toggle('expanded');
                                    }
                                });
                            });

                            if (displayedMeetingsCount > 0) {
                                showMessage(`找到 ${displayedMeetingsCount} 條結果。`, 'success');
                            } else {
                                resultsContainer.innerHTML = '<p class="text-gray-500 text-center">沒有找到符合條件的會議紀錄。</p>';
                                showMessage('沒有找到符合條件的會議紀錄。', 'info');
                            }

                        } else {
                            resultsContainer.innerHTML = '<p class="text-gray-500 text-center">沒有找到符合條件的會議紀錄。</p>';
                            updateMonthNav(currentNavYear, new Set());
                            showMessage('沒有找到符合條件的會議紀錄。', 'info');
                        }
                    } else {
                        resultsContainer.innerHTML = `<p class="text-red-500 text-center">查詢失敗: ${result.message}</p>`;
                        showMessage(`查詢失敗: ${result.message}`, 'error');
                    }
                } catch (error) {
                    console.error('查詢過程中發生錯誤:', error);
                    resultsContainer.innerHTML = '<p class="text-red-500 text-center">網路錯誤或 Apps Script 發生問題。請檢查控制台。</p>';
                    showMessage('網路錯誤或 Apps Script 發生問題。', 'error');
                }
            }

            searchButton.addEventListener('click', () => {
                const keyword = keywordInput.value.trim();
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                performSearch(keyword, startDate, endDate);
            });

            showAllButton.addEventListener('click', () => {
                keywordInput.value = '';
                startDateInput.value = '';
                endDateInput.value = '';
                performSearch('', '', '', true);
            });

            keywordInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    searchButton.click();
                }
            });

            addMeetingButton.addEventListener('click', () => {
                loginModal.classList.remove('hidden');
                loginModal.classList.add('flex');
                usernameInput.value = '';
                passwordInput.value = '';
                loginMessage.classList.add('hidden');
                usernameInput.focus();
                
                // 設置目標 URL 為新增模式
                loginButton.dataset.targetUrl = MEETING_INPUT_PAGE_URL;
            });

            document.addEventListener('click', (event) => {
                if (event.target.classList.contains('edit-button')) {
                    const rowIndex = event.target.dataset.rowIndex;
                    loginModal.classList.remove('hidden');
                    loginModal.classList.add('flex');
                    usernameInput.value = '';
                    passwordInput.value = '';
                    loginMessage.classList.add('hidden');
                    usernameInput.focus();
                    
                    loginButton.dataset.targetUrl = `${MEETING_INPUT_PAGE_URL}?editRow=${rowIndex}`;
                }
            });


            loginModal.addEventListener('click', (event) => {
                if (event.target === loginModal) {
                    loginModal.classList.add('hidden');
                    loginModal.classList.remove('flex');
                }
            });
            cancelLoginButton.addEventListener('click', () => {
                loginModal.classList.add('hidden');
                loginModal.classList.remove('flex');
            });

            loginButton.addEventListener('click', () => {
                const username = usernameInput.value;
                const password = passwordInput.value;

                if (username === 'cmh9002' && password === 'cmh9002') {
                    loginMessage.classList.add('hidden');
                    loginModal.classList.add('hidden');
                    loginModal.classList.remove('flex');
                    const targetUrl = loginButton.dataset.targetUrl || MEETING_INPUT_PAGE_URL;
                    window.location.href = targetUrl;
                } else {
                    loginMessage.textContent = '帳號或密碼錯誤，請重新輸入。';
                    loginMessage.classList.remove('hidden');
                }
            });

            usernameInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    passwordInput.focus();
                }
            });
            passwordInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    loginButton.click();
                }
            });

            window.openDocumentViewer = function(url) {
                let embedUrl = url;
                if (url.includes('docs.google.com/document/d/') || url.includes('docs.google.com/spreadsheets/d/') || url.includes('docs.google.com/presentation/d/')) {
                    embedUrl = url.replace(/\/edit|\/view/, '/embed');
                } else if (url.includes('drive.google.com/file/d/')) {
                    embedUrl = url.replace(/\/view\?usp=sharing/, '/preview');
                }
                
                documentViewerIframe.src = embedUrl;
                documentViewerModal.classList.add('flex');
                documentViewerModal.classList.remove('hidden');
            };

            closeDocumentViewerButton.addEventListener('click', () => {
                documentViewerModal.classList.add('hidden');
                documentViewerModal.classList.remove('flex');
                documentViewerIframe.src = '';
            });

            documentViewerModal.addEventListener('click', (event) => {
                if (event.target === documentViewerModal) {
                    documentViewerModal.classList.add('hidden');
                    documentViewerModal.classList.remove('flex');
                    documentViewerIframe.src = '';
                }
            });
            
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.get('keyword') && !urlParams.get('startDate') && !urlParams.get('endDate')) {
                performSearch('', '', '', true);
            }
        });
    </script>
</body>
</html>
