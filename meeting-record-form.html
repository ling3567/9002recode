<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒè­°å…§å®¹è¼¸å…¥/ç·¨è¼¯</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ TinyMCE (å¯Œæ–‡å­—ç·¨è¼¯å™¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        /* è¨­å®š Inter å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* æ·ºç°è‰²èƒŒæ™¯ */
        }
        /* è‡ªè¨‚ç¢ºèªè¦–çª—æ¨£å¼ */
        #deleteConfirmModal {
            display: none; /* é è¨­éš±è— */
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        #deleteConfirmModal.flex {
            display: flex; /* é¡¯ç¤ºæ™‚è®Šç‚º flex */
        }
        /* èª¿æ•´ç·¨è¼¯å™¨èˆ‡ Tailwind çš„ç›¸å®¹æ€§ */
        .tox-tinymce {
            border-radius: 0.375rem !important; /* rounded-md */
            border-color: #d1d5db !important; /* border-gray-300 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl border border-gray-200">
        <h1 id="formTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">æ–°å¢æœƒè­°å…§å®¹</h1>

        <!-- æª”æ¡ˆè§£æå€åŸŸ -->
        <div class="mb-6 p-4 border border-gray-300 rounded-md bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">ä¸Šå‚³æœƒè­°ç´€éŒ„æª”æ¡ˆä¸¦è‡ªå‹•è§£æ</h2>
            <p class="text-sm text-gray-500 mb-4">è«‹ä¸Šå‚³æ–‡å­—æª” (.txt) æˆ– Word æª” (.docx)ï¼Œç¨‹å¼æœƒå˜—è©¦è‡ªå‹•è§£æä¸¦å¡«å…¥ä¸‹æ–¹æ¬„ä½ã€‚</p>
            <div class="flex items-center space-x-4">
                <input type="file" id="fileInput"
                       class="flex-grow block w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-md file:border-0
                       file:text-sm file:font-semibold
                       file:bg-blue-50 file:text-blue-700
                       hover:file:bg-blue-100"
                       accept=".txt,.docx">
                <button type="button" id="parseFileButton"
                        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out whitespace-nowrap disabled:opacity-50">
                    è§£ææª”æ¡ˆ
                </button>
            </div>
        </div>

        <form id="meetingForm">
            <input type="hidden" id="rowIndex" name="rowIndex">

            <!-- ç‹€æ…‹ï¼šæœªå¬é–‹æœƒè­° -->
            <div class="mb-4 p-4 border border-yellow-300 rounded-md bg-yellow-50">
                <div class="flex items-center">
                    <input type="checkbox" id="noMeetingCheckbox" name="ç‹€æ…‹" value="æœªå¬é–‹"
                           class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="noMeetingCheckbox" class="ml-3 block text-lg font-medium text-yellow-800">
                        å‹¾é¸æ­¤é …ï¼Œæ¨™è¨˜ç‚ºã€Œæœ¬æœˆæœªå¬é–‹æœƒè­°ã€
                    </label>
                </div>
                <p class="text-sm text-yellow-600 mt-2 ml-8">å‹¾é¸å¾Œï¼Œåƒ…éœ€å¡«å¯«æœƒè­°åç¨±å’Œæ—¥æœŸå³å¯æäº¤ï¼Œå…¶ä»–æ¬„ä½å°‡è¢«éš±è—ã€‚</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- æœƒè­°åç¨± -->
                <div>
                    <label for="meetingName" class="block text-sm font-medium text-gray-700 mb-1">æœƒè­°åç¨±</label>
                    <input type="text" id="meetingName" name="æœƒè­°åç¨±" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- æœƒè­°æ—¥æœŸ -->
                <div>
                    <label for="meetingDate" class="block text-sm font-medium text-gray-700 mb-1">æœƒè­°æ—¥æœŸ</label>
                    <input type="date" id="meetingDate" name="æœƒè­°æ—¥æœŸ" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
            </div>

            <!-- å¯éš±è—çš„å…§å®¹æ¬„ä½ -->
            <div id="contentFields" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <!-- é–‹å§‹æ™‚é–“ -->
                <div>
                    <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“</label>
                    <input type="time" id="startTime" name="é–‹å§‹æ™‚é–“" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- çµæŸæ™‚é–“ -->
                <div>
                    <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ™‚é–“</label>
                    <input type="time" id="endTime" name="çµæŸæ™‚é–“" required
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- æœƒè­°åœ°é» -->
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-1">æœƒè­°åœ°é»</label>
                    <input type="text" id="location" name="æœƒè­°åœ°é»"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- ä¸»å¸­ -->
                <div>
                    <label for="chairman" class="block text-sm font-medium text-gray-700 mb-1">ä¸»å¸­</label>
                    <input type="text" id="chairman" name="ä¸»å¸­"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- å£¹ã€é ’çè¡¨æš (å¯Œæ–‡å­—) -->
                <div class="md:col-span-2">
                    <label for="awards" class="block text-sm font-medium text-gray-700 mb-1">å£¹ã€é ’çè¡¨æš</label>
                    <div class="text-xs text-gray-500 mb-1">æ”¯æ´è¡¨æ ¼æ’å…¥ã€‚åœ–ç‰‡è«‹ä½¿ç”¨é€£çµ (URL)ã€‚</div>
                    <textarea id="awards" name="å£¹ã€é ’çè¡¨æš" rows="3" class="rich-editor mt-1 block w-full shadow-sm"></textarea>
                </div>

                <!-- è²³ã€ä¸»å¸­å ±å‘Š (å¯Œæ–‡å­—) -->
                <div class="md:col-span-2">
                    <label for="chairmanReport" class="block text-sm font-medium text-gray-700 mb-1">è²³ã€ä¸»å¸­å ±å‘Š</label>
                    <div class="text-xs text-gray-500 mb-1">æ”¯æ´è¡¨æ ¼æ’å…¥ã€‚åœ–ç‰‡è«‹ä½¿ç”¨é€£çµ (URL)ã€‚</div>
                    <textarea id="chairmanReport" name="è²³ã€ä¸»å¸­å ±å‘Š" rows="3" class="rich-editor mt-1 block w-full shadow-sm"></textarea>
                </div>

                <!-- åƒã€ä¸Šæ¬¡æœƒè­°è¿½è¹¤äº‹é … (å¯Œæ–‡å­—) -->
                <div class="md:col-span-2">
                    <label for="lastMeetingFollowUp" class="block text-sm font-medium text-gray-700 mb-1">åƒã€ä¸Šæ¬¡æœƒè­°è¿½è¹¤äº‹é …</label>
                    <textarea id="lastMeetingFollowUp" name="åƒã€ä¸Šæ¬¡æœƒè­°è¿½è¹¤äº‹é …" rows="3" class="rich-editor mt-1 block w-full shadow-sm"></textarea>
                </div>

                <!-- è‚†ã€æœ¬æ¬¡æœƒè­°å ±å‘ŠåŠè¨è«–äº‹é … (å¯Œæ–‡å­—) -->
                <div class="md:col-span-2">
                    <div class="flex justify-between items-center mb-1">
                        <label for="currentMeetingDiscussion" class="block text-sm font-medium text-gray-700">
                            è‚†ã€æœ¬æ¬¡æœƒè­°å ±å‘ŠåŠè¨è«–äº‹é …
                        </label>
                        <!-- æ–°å¢è‡ªå‹•æ’ç‰ˆæŒ‰éˆ• -->
                        <button type="button" onclick="manualFormatDiscussion()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition">
                            ğŸª„ è‡ªå‹•æ’ç‰ˆ (è½‰ç‚ºå¡ç‰‡)
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">æ­¤æ¬„ä½æ”¯æ´å¡ç‰‡å¼æ’ç‰ˆã€‚è‹¥æ‰‹å‹•è²¼ä¸Šæ–‡å­—ï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œè‡ªå‹•æ’ç‰ˆã€æŒ‰éˆ•ã€‚</div>
                    <textarea
                        id="currentMeetingDiscussion"
                        name="è‚†ã€æœ¬æ¬¡æœƒè­°å ±å‘ŠåŠè¨è«–äº‹é …"
                        rows="3"
                        class="rich-editor mt-1 block w-full shadow-sm"
                        placeholder="è«‹è¼¸å…¥æœ¬æ¬¡æœƒè­°çš„å ±å‘Šé‡é»ã€è¨è«–å…§å®¹èˆ‡æ±ºè­°ï¼Œå»ºè­°åˆ†æ¢åˆ—å‡º">
                    </textarea>
                </div>

                <!-- ä¼ã€è‡¨æ™‚å‹•è­° (å¯Œæ–‡å­—) -->
                <div class="md:col-span-2">
                    <label for="adHocMotion" class="block text-sm font-medium text-gray-700 mb-1">ä¼ã€è‡¨æ™‚å‹•è­°</label>
                    <textarea id="adHocMotion" name="ä¼ã€è‡¨æ™‚å‹•è­°" rows="3" class="rich-editor mt-1 block w-full shadow-sm"></textarea>
                </div>

                <!-- é™¸ã€ä¸‹æ¬¡æœƒè­°è¿½è¹¤äº‹é … (å¯Œæ–‡å­—) -->
                <div class="col-span-2">
                    <label for="nextMeetingFollowUp" class="block text-sm font-medium text-gray-700 mb-1">é™¸ã€ä¸‹æ¬¡æœƒè­°è¿½è¹¤äº‹é …</label>
                    <textarea id="nextMeetingFollowUp" name="é™¸ã€ä¸‹æ¬¡æœƒè­°è¿½è¹¤äº‹é …" rows="3" class="rich-editor mt-1 block w-full shadow-sm"></textarea>
                </div>

                <!-- æŸ’ã€ä¸»å¸­çµè«– (å¯Œæ–‡å­—) -->
                <div class="md:col-span-2">
                    <label for="chairmanConclusion" class="block text-sm font-medium text-gray-700 mb-1">æŸ’ã€ä¸»å¸­çµè«–</label>
                    <textarea id="chairmanConclusion" name="æŸ’ã€ä¸»å¸­çµè«–" rows="3" class="rich-editor mt-1 block w-full shadow-sm"></textarea>
                </div>

                <!-- é™„ä»¶åç¨± (ä¿æŒç´”æ–‡å­—ï¼Œå› ç‚ºæ ¼å¼è¼ƒå–®ç´”) -->
                <div class="md:col-span-2">
                    <label for="attachmentName" class="block text-sm font-medium text-gray-700 mb-1">é™„ä»¶</label>
                    <textarea id="attachmentName" name="é™„ä»¶åç¨±" rows="3" placeholder="è«‹è¼¸å…¥é™„ä»¶åç¨±å’Œå…±ç”¨é€£çµï¼Œæ¯ä»½é™„ä»¶ä¸€è¡Œï¼Œä¾‹å¦‚ï¼š&#10;é™„ä»¶ä¸€ æ–‡ä»¶åç¨±: https://docs.google.com/document/d/YOUR_DOC_ID/edit&#10;é™„ä»¶äºŒ åœ–ç‰‡èªªæ˜: https://drive.google.com/file/d/ANOTHER_FILE_ID/view"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>
            </div> <!-- çµæŸ #contentFields -->

            <!-- å»ºç«‹æ™‚é–“ (è‡ªå‹•å¡«å…¥) -->
            <div class="mt-6">
                <label for="creationTime" class="block text-sm font-medium text-gray-700 mb-1">å»ºç«‹æ™‚é–“</label>
                <input type="datetime-local" id="creationTime" name="å»ºç«‹æ™‚é–“" readonly
                       class="mt-1 block w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-500">
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <div class="md:col-span-2 flex justify-center mt-6">
                <button type="submit"
                        class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    æäº¤æœƒè­°å…§å®¹
                </button>
            </div>
            <div class="md:col-span-2 flex justify-center mt-4">
                <button type="button" id="deleteButton"
                        class="hidden px-8 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    åˆªé™¤æœƒè­°ç´€éŒ„
                </button>
            </div>
        </form>

        <!-- è¨Šæ¯é¡¯ç¤ºå€å¡Š -->
        <div id="messageContainer" class="mt-6 p-4 rounded-md hidden">
            <p id="messageText" class="text-center"></p>
        </div>
    </div>

    <!-- è‡ªè¨‚åˆªé™¤ç¢ºèªè¦–çª— -->
    <div id="deleteConfirmModal" class="fixed inset-0 items-center justify-center p-4 modal-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm modal-content relative">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h2>
            <p class="text-gray-600 text-center mb-6">é€™å€‹å‹•ä½œç„¡æ³•å¾©åŸã€‚è«‹ç¢ºèªæ˜¯å¦è¦æ°¸ä¹…åˆªé™¤é€™ç­†æœƒè­°ç´€éŒ„ã€‚</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteButton"
                        class="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    å–æ¶ˆ
                </button>
                <button id="confirmDeleteButton"
                        class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    ç¢ºå®šåˆªé™¤
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
    <script>
        // *** å…¨åŸŸè¼”åŠ©å‡½æ•¸ï¼šæ‰‹å‹•è§¸ç™¼æ’ç‰ˆ ***
        // é€™æ˜¯çµ¦ "è‡ªå‹•æ’ç‰ˆ" æŒ‰éˆ•ç”¨çš„
        window.manualFormatDiscussion = function() {
            const editor = tinymce.get('currentMeetingDiscussion');
            if (editor) {
                // 1. å–å¾—ç›®å‰å…§å®¹ (å¯èƒ½æ˜¯ HTML)
                let content = editor.getContent({format: 'text'}); // å…ˆå–ç´”æ–‡å­—ä»¥æ¸…é™¤é«’ HTML
                if (!content.trim()) return;

                // 2. é‡æ–°åŸ·è¡Œæ ¼å¼åŒ–é‚è¼¯
                // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘å‡è¨­ä½¿ç”¨è€…è²¼ä¸Šçš„æ˜¯ç´”æ–‡å­—ï¼Œæˆ‘å€‘é‡æ–°æŠŠå®ƒè½‰æˆå¡ç‰‡ HTML
                // å¦‚æœå…§å®¹å·²ç¶“æ˜¯ HTMLï¼ŒgetContent('text') æœƒéæ¿¾æ‰æ¨™ç±¤ï¼Œåªå‰©æ–‡å­—ï¼Œ
                // é€™å‰›å¥½å¯ä»¥è®“æˆ‘å€‘é‡æ–°å»ºç«‹ä¹¾æ·¨çš„å¡ç‰‡çµæ§‹
                const formattedHtml = formatMeetingContent(content, 'currentMeetingDiscussion');
                editor.setContent(formattedHtml);
            }
        };

        // *** æ ¼å¼åŒ–å‡½æ•¸å®šç¾© (æ‹‰å‡ºä¾†ä»¥ä¾¿å…±ç”¨) ***
        function decodeHtmlEntities(text) {
            if (!text) return text;
            const txt = document.createElement("textarea");
            txt.innerHTML = text;
            return txt.value;
        }

        // å»ºç«‹å¡ç‰‡ HTML çš„è¼”åŠ©å‡½æ•¸
        function createCardHtml(lines) {
            if (lines.length === 0) return '';
            
            let titleHtml = lines[0];
            const headerRegex = /^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€.*?[ï¼š:])?(.*)/;
            
            if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/.test(titleHtml)) {
                    titleHtml = titleHtml.replace(headerRegex, (match, p1, p2) => {
                    if (p1) return `<strong>${p1}</strong>${p2}`; 
                    return `<strong>${match}</strong>`; 
                });
            }

            const contentHtml = lines.slice(1).map(l => {
                let className = '';
                if (/^\(\d+\)/.test(l)) className = 'num-level-2';
                else if (/^\d+\./.test(l)) className = 'num-level-1';
                else if (/^[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©]/.test(l)) className = 'num-circle-1';
                else if (/^\s*[a-e]\./i.test(l)) className = 'num-alpha-1';
                const classAttr = className ? ` class="${className}"` : '';
                return `<p${classAttr}>${l}</p>`;
            }).join('');

            return `<div class="editor-card"><p>${titleHtml}</p>${contentHtml}</div>`;
        }

        // æ ¸å¿ƒæ ¼å¼åŒ–å‡½æ•¸
        function formatMeetingContent(text, fieldId) {
            if (!text) return '';

            let formatted = decodeHtmlEntities(text);

            // 1. å¼·åŠ›æ¸…æ´—
            let raw = formatted
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<\/p>/gi, '\n')
                .replace(/<p[^>]*>/gi, '')
                .replace(/<\/div>/gi, '\n')
                .replace(/<div[^>]*>/gi, '');

            // 2. åˆ‡å‰²ä¸¦éæ¿¾ç©ºè¡Œ
            const lines = raw.split('\n').map(l => l.trim()).filter(l => l);

            // 3. è™•ç† "è‚†" å€å¡Šçš„å¡ç‰‡ (currentMeetingDiscussion)
            if (fieldId === 'currentMeetingDiscussion') {
                const cards = [];
                let currentCardContent = [];
                const headerRegex = /^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/;

                lines.forEach((line) => {
                    if (headerRegex.test(line)) {
                        if (currentCardContent.length > 0) {
                            cards.push(createCardHtml(currentCardContent));
                            currentCardContent = [];
                        }
                    }
                    currentCardContent.push(line);
                });

                if (currentCardContent.length > 0) {
                    cards.push(createCardHtml(currentCardContent));
                }

                if (cards.length === 0) {
                    return lines.map(l => `<p>${l}</p>`).join('');
                }

                return cards.join('');
            }

            // 4. å…¶ä»–æ¬„ä½è™•ç†
            return lines.map(line => {
                let className = '';
                if (/^\(\d+\)/.test(line)) className = 'num-level-2';
                else if (/^\d+\./.test(line)) className = 'num-level-1';
                else if (/^[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©]/.test(line)) className = 'num-circle-1';
                else if (/^\s*[a-e]\./i.test(line)) className = 'num-alpha-1';
                else if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/.test(line)) className = 'num-cn-1';

                const classAttr = className ? ` class="${className}"` : '';
                return `<p${classAttr}>${line}</p>`;
            }).join('');
        }

        // *** DOMContentLoaded ***
        document.addEventListener('DOMContentLoaded', () => {

            // *** 0. åˆå§‹åŒ– TinyMCE ç·¨è¼¯å™¨ ***
            tinymce.init({
                selector: '.rich-editor',
                language: 'zh_TW',
                language_url: 'https://cdn.jsdelivr.net/npm/tinymce-i18n/langs/zh_TW.js',
                height: 300,
                menubar: false,
                statusbar: false,
                entity_encoding: 'raw',
                paste_data_images: false,
                content_style: `
                    body { font-family: 'Inter', sans-serif; font-size: 16px; color: #374151; line-height: 1.75; }
                    p { margin: 0; padding: 0; margin-bottom: 0.5em; }
                    strong { color: #1a202c; font-weight: 700; }
                    ul, ol { margin: 0; padding: 0; }
                    table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
                    table td, table th { border: 1px solid #ddd; padding: 8px; }
                    .editor-card {
                        background-color: #f8fafc;
                        border: 1px solid #e2e8f0;
                        border-radius: 12px;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
                    }
                    .num-level-1 { margin-left: 0 !important; padding-left: 0.8em !important; text-indent: -0.8em !important; }
                    .num-level-2 { margin-left: 0.8em; padding-left: 1.2em; text-indent: -1.2em; }
                    .num-cn-1 { padding-left: 2em; text-indent: -2em; }
                    .num-circle-1 { margin-left: 41px; padding-left: 10px; text-indent: -10px; }
                    .num-alpha-1 { margin-left: 49px; padding-left: 8px; text-indent: -8px; }
                `,
                plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table code help wordcount',
                toolbar: 'undo redo | blocks | bold italic forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist | link image table | removeformat | help',
                branding: false,
                promotion: false
            });

            // *** è¼”åŠ©å‡½æ•¸å®šç¾© ***

            function showMessage(text, type = 'info', duration = 3000) {
                const messageContainer = document.getElementById('messageContainer');
                const messageText = document.getElementById('messageText');
                if (!messageContainer || !messageText) return;

                messageText.textContent = text;
                messageContainer.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');

                if (type === 'success') {
                    messageContainer.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    messageContainer.classList.add('bg-red-100', 'text-red-800');
                } else { // info or loading
                    messageContainer.classList.add('bg-blue-100', 'text-blue-800');
                }
                messageContainer.classList.remove('hidden');

                if (duration > 0) {
                    setTimeout(() => {
                        messageContainer.classList.add('hidden');
                    }, duration);
                }
            }

            function setFieldValue(id, value) {
                const editor = tinymce.get(id); 
                if (editor) {
                    const formattedValue = formatMeetingContent(value, id);
                    editor.setContent(formattedValue || ''); 
                } else {
                    const el = document.getElementById(id); 
                    if (el) el.value = value || '';
                }
            }

            // *** é—œéµä¿®æ­£ï¼šç« ç¯€æ­£è¦åŒ–å‡½æ•¸ (è§£æ±º 11306 å•é¡Œ) ***
            function normalizeMeetingText(text) {
                if (!text) return "";
                // å°‡èˆŠç‰ˆç« ç¯€æ¨™é¡Œå°æ‡‰åˆ°æ–°ç‰ˆï¼Œç¢ºä¿å¾Œç«¯èƒ½æŠ“åˆ°æ­£ç¢ºæ¬„ä½
                let normalized = text;
                // 11306 èˆŠç‰ˆçµæ§‹ -> æ–°ç‰ˆçµæ§‹
                // å£¹ã€ä¸»å¸­å ±å‘Š -> è²³ã€ä¸»å¸­å ±å‘Š (å‡è¨­ 11501 çš„ å£¹ æ˜¯é ’ç)
                // åƒã€æœ¬æ¬¡æœƒè­° -> è‚†ã€æœ¬æ¬¡æœƒè­° (é—œéµä¿®æ­£)
                // è‚†ã€è‡¨æ™‚å‹•è­° -> ä¼ã€è‡¨æ™‚å‹•è­°
                // ä¼ã€ä¸‹æ¬¡æœƒè­° -> é™¸ã€ä¸‹æ¬¡æœƒè­°
                // é™¸ã€ä¸»å¸­çµè«– -> æŸ’ã€ä¸»å¸­çµè«–
                // æŸ’ã€æ•£æœƒ -> æŒã€æ•£æœƒ

                // æ³¨æ„é †åºï¼Œé¿å…é‡è¤‡æ›¿æ› (ä¾‹å¦‚å…ˆæŠŠ é™¸ æ›æˆ æŸ’ï¼Œç„¶å¾ŒåˆæŠŠ ä¼ æ›æˆ é™¸)
                // ä½¿ç”¨å–ä»£æ™‚ï¼Œæœ€å¥½åŠ ä¸Š ^ æˆ– \n ç¢ºä¿æ˜¯è¡Œé¦–
                // ä½†å› ç‚º mammoth è½‰å‡ºä¾†çš„æ–‡å­—å¯èƒ½æœƒæœ‰ä¸å¯è¦‹å­—å…ƒï¼Œç”¨å¯¬é¬†ä¸€é»çš„ regex
                
                // å…ˆè™•ç†æœ€å¤§çš„ä½ç§»
                normalized = normalized.replace(/(^|\n)\s*æŸ’ã€/g, "$1æŒã€");
                normalized = normalized.replace(/(^|\n)\s*é™¸ã€/g, "$1æŸ’ã€");
                normalized = normalized.replace(/(^|\n)\s*ä¼ã€/g, "$1é™¸ã€");
                normalized = normalized.replace(/(^|\n)\s*è‚†ã€/g, "$1ä¼ã€");
                // *** é—œéµï¼šæŠŠã€Œåƒã€æœ¬æ¬¡æœƒè­°...ã€è½‰ç‚ºã€Œè‚†ã€...ã€ ***
                normalized = normalized.replace(/(^|\n)\s*åƒã€/g, "$1è‚†ã€");
                normalized = normalized.replace(/(^|\n)\s*è²³ã€/g, "$1åƒã€");
                normalized = normalized.replace(/(^|\n)\s*å£¹ã€/g, "$1è²³ã€");

                return normalized;
            }

            async function loadMeetingData(rowIndex, url) {
                // ... (ä¿æŒåŸæ¨£ï¼Œé€™éƒ¨åˆ†è™•ç†å¾ Google Sheet è®€å›ä¾†çš„è³‡æ–™)
                const formTitle = document.getElementById('formTitle');
                const deleteButton = document.getElementById('deleteButton');
                const rowIndexInput = document.getElementById('rowIndex');
                const creationTimeInput = document.getElementById('creationTime');
                const noMeetingCheckbox = document.getElementById('noMeetingCheckbox');

                formTitle.textContent = 'ç·¨è¼¯æœƒè­°å…§å®¹';
                deleteButton.classList.remove('hidden');
                showMessage('æ­£åœ¨è¼‰å…¥è³‡æ–™...', 'info', 0);

                try {
                    const fetchUrl = `${url}?action=getRecord&rowIndex=${rowIndex}`;
                    const response = await fetch(fetchUrl);
                    const result = await response.json();

                    if (result.success && result.data) {
                        const data = result.data;
                        setFieldValue('meetingName', data['æœƒè­°åç¨±']);
                        setFieldValue('meetingDate', data['æœƒè­°æ—¥æœŸ']);
                        setFieldValue('startTime', data['é–‹å§‹æ™‚é–“']);
                        setFieldValue('endTime', data['çµæŸæ™‚é–“']);
                        setFieldValue('location', data['æœƒè­°åœ°é»']);
                        setFieldValue('chairman', data['ä¸»å¸­']);

                        setFieldValue('awards', data['å£¹ã€é ’çè¡¨æš']);
                        setFieldValue('chairmanReport', data['è²³ã€ä¸»å¸­å ±å‘Š']);
                        setFieldValue('lastMeetingFollowUp', data['åƒã€ä¸Šæ¬¡æœƒè­°è¿½è¹¤äº‹é …']);
                        setFieldValue('currentMeetingDiscussion', data['è‚†ã€æœ¬æ¬¡æœƒè­°å ±å‘ŠåŠè¨è«–äº‹é …']);
                        setFieldValue('adHocMotion', data['ä¼ã€è‡¨æ™‚å‹•è­°']);
                        setFieldValue('nextMeetingFollowUp', data['é™¸ã€ä¸‹æ¬¡æœƒè­°è¿½è¹¤äº‹é …']);
                        setFieldValue('chairmanConclusion', data['æŸ’ã€ä¸»å¸­çµè«–']);

                        setFieldValue('attachmentName', data['é™„ä»¶åç¨±']);

                        creationTimeInput.value = data['å»ºç«‹æ™‚é–“'] || '';

                        if (data['ç‹€æ…‹'] === 'æœªå¬é–‹') {
                            noMeetingCheckbox.checked = true;
                            noMeetingCheckbox.dispatchEvent(new Event('change'));
                        }

                        rowIndexInput.value = rowIndex;
                        showMessage('è³‡æ–™è¼‰å…¥æˆåŠŸï¼', 'success');
                    } else {
                        showMessage('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                    }
                } catch (error) {
                    showMessage('ç¶²è·¯éŒ¯èª¤æˆ– Apps Script ç™¼ç”Ÿå•é¡Œã€‚', 'error');
                    console.error('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
            }

            async function submitForm(event, url) {
                event.preventDefault();
                const form = document.getElementById('meetingForm');
                const rowIndexInput = document.getElementById('rowIndex');
                const creationTimeInput = document.getElementById('creationTime');

                tinymce.triggerSave();

                showMessage('æ­£åœ¨æäº¤è³‡æ–™ä¸­ï¼Œè«‹ç¨å€™...', 'info', 0);

                const formData = new FormData(form);
                const meetingData = {};
                for (let [key, value] of formData.entries()) {
                    meetingData[key] = value;
                }

                if (!meetingData['ç‹€æ…‹']) {
                    meetingData['ç‹€æ…‹'] = '';
                }

                const isUpdate = !!rowIndexInput.value;
                if (isUpdate) {
                    meetingData.action = 'updateRecord';
                    meetingData.rowIndex = rowIndexInput.value;
                    meetingData['å»ºç«‹æ™‚é–“'] = creationTimeInput.value;
                } else {
                    meetingData.action = 'addRecord';
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    meetingData['å»ºç«‹æ™‚é–“'] = now.toISOString().slice(0, 16);
                }

                console.log('æº–å‚™æäº¤çš„æœƒè­°è³‡æ–™:', meetingData);
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: new URLSearchParams(meetingData),
                    });

                    const result = await response.json();
                    if (result.success) {
                        showMessage(isUpdate ? 'æœƒè­°å…§å®¹å·²æˆåŠŸæ›´æ–°ï¼' : 'æœƒè­°å…§å®¹å·²æˆåŠŸå„²å­˜ï¼', 'success');
                        setTimeout(() => {
                           try { window.location.href = 'index.html'; } 
                           catch (e) { console.warn('ç„¡æ³•å°èˆª:', e); }
                        }, 2000);
                    } else {
                        showMessage('å„²å­˜å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                    }
                } catch (error) {
                    console.error('ç™¼é€è³‡æ–™åˆ° Apps Script æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    showMessage('ç¶²è·¯éŒ¯èª¤æˆ– Apps Script ç™¼ç”Ÿå•é¡Œã€‚è«‹æª¢æŸ¥æ§åˆ¶å°ã€‚', 'error');
                }
            }

            function showDeleteConfirm(callback) {
                const modal = document.getElementById('deleteConfirmModal');
                const confirmBtn = document.getElementById('confirmDeleteButton');
                const cancelBtn = document.getElementById('cancelDeleteButton');
                modal.classList.add('flex');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newConfirmBtn.addEventListener('click', () => { callback(true); hideDeleteConfirm(); });
                newCancelBtn.addEventListener('click', () => { callback(false); hideDeleteConfirm(); });
            }

            function hideDeleteConfirm() {
                const modal = document.getElementById('deleteConfirmModal');
                modal.classList.remove('flex');
            }

            const form = document.getElementById('meetingForm');
            const creationTimeInput = document.getElementById('creationTime');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            const formTitle = document.getElementById('formTitle');
            const rowIndexInput = document.getElementById('rowIndex');
            const deleteButton = document.getElementById('deleteButton');
            const fileInput = document.getElementById('fileInput');
            const parseFileButton = document.getElementById('parseFileButton');
            const noMeetingCheckbox = document.getElementById('noMeetingCheckbox');
            const contentFields = document.getElementById('contentFields');

            const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxgkjyZdtiSBDMuHtuwJweCeyxXVzGnn8VtwnvhXwyQMcPthHpdtoAIZgeeAWixJICm/exec';

            const urlParams = new URLSearchParams(window.location.search);
            const editRowIndex = urlParams.get('editRow');

            if (editRowIndex) {
                loadMeetingData(editRowIndex, APPS_SCRIPT_WEB_APP_URL);
            } else {
                formTitle.textContent = 'æ–°å¢æœƒè­°å…§å®¹';
                deleteButton.classList.add('hidden');
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                creationTimeInput.value = now.toISOString().slice(0, 16);
                startTimeInput.value = '12:30';
                document.getElementById('location').value = 'ç¬¬äº”é†«ç™‚å¤§æ¨“äº”æ¨“552æœƒè­°å®¤';
                document.getElementById('chairman').value = 'é™³å¿—æˆ';
            }

            // *** æª”æ¡ˆè§£æé‚è¼¯ (æ·±åº¦æ¸…æ´— + æ­£è¦åŒ– + é˜»æ“‹åœ–ç‰‡) ***
            parseFileButton.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) {
                    showMessage('è«‹é¸æ“‡ä¸€å€‹æª”æ¡ˆï¼', 'error');
                    return;
                }

                parseFileButton.disabled = true;
                parseFileButton.textContent = 'è§£æä¸­...';
                showMessage('æ­£åœ¨è§£ææª”æ¡ˆ...', 'info', 0);

                try {
                    let fileContent = '';
                    const fileReader = new FileReader();

                    if (file.name.endsWith('.docx')) {
                        fileContent = await new Promise((resolve, reject) => {
                            fileReader.onload = (e) => {
                                var options = {
                                    convertImage: mammoth.images.imgElement(function(image) {
                                        return Promise.resolve({ src: "" }); 
                                    })
                                };
                                
                                mammoth.convertToHtml({ arrayBuffer: e.target.result }, options)
                                    .then(result => {
                                        let html = result.value;
                                        html = html.replace(/<\/(p|div|h[1-6]|li|blockquote)>/gi, '\n\n'); 
                                        html = html.replace(/<\/tr>/gi, '\n');
                                        html = html.replace(/<\/(td|th)>/gi, '  '); 
                                        html = html.replace(/<br\s*\/?>/gi, '\n');
                                        
                                        let text = html.replace(/<[^>]+>/g, '');
                                        const doc = new DOMParser().parseFromString(text, 'text/html');
                                        text = doc.body.textContent || "";
                                        text = text.replace(/[\x0b\f\u2028\u2029]/g, '\n');
                                        text = text.replace(/â‰§/g, '>=');
                                        text = text.replace(/â†’/g, '->');
                                        
                                        // *** æ‡‰ç”¨ç« ç¯€æ­£è¦åŒ– (è§£æ±º 11306 å•é¡Œ) ***
                                        // å¦‚æœåµæ¸¬åˆ°èˆŠç‰ˆ "åƒã€æœ¬æ¬¡æœƒè­°"ï¼Œè‡ªå‹•è½‰æˆ "è‚†ã€æœ¬æ¬¡æœƒè­°"
                                        if (text.includes("åƒã€æœ¬æ¬¡æœƒè­°å ±å‘ŠåŠè¨è«–äº‹é …")) {
                                            text = normalizeMeetingText(text);
                                            console.log("åµæ¸¬åˆ°èˆŠç‰ˆæ ¼å¼ï¼Œå·²è‡ªå‹•æ­£è¦åŒ–ç« ç¯€ç·¨è™Ÿã€‚");
                                        }

                                        const lines = text.split(/\r\n|\r|\n/);
                                        const cleanedLines = lines
                                            .map(line => line.trim()) 
                                            .filter(line => line.length > 0);

                                        resolve(cleanedLines.join('\n'));
                                    })
                                    .catch(reject);
                            };
                            fileReader.onerror = reject;
                            fileReader.readAsArrayBuffer(file);
                        });
                    } else {
                        fileContent = await new Promise((resolve, reject) => {
                            fileReader.onload = (e) => resolve(e.target.result);
                            fileReader.onerror = reject;
                            fileReader.readAsText(file);
                        });
                    }

                    const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                        method: 'POST',
                        body: new URLSearchParams({
                            action: 'parseFileContent',
                            fileContent: fileContent
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        const parsedData = result.data;
                        setFieldValue('meetingName', parsedData['æœƒè­°åç¨±']);
                        setFieldValue('meetingDate', parsedData['æœƒè­°æ—¥æœŸ']);
                        setFieldValue('startTime', parsedData['é–‹å§‹æ™‚é–“']);
                        setFieldValue('endTime', parsedData['çµæŸæ™‚é–“']);
                        setFieldValue('location', parsedData['æœƒè­°åœ°é»']);
                        setFieldValue('chairman', parsedData['ä¸»å¸­']);

                        setFieldValue('awards', parsedData['å£¹ã€é ’çè¡¨æš']);
                        setFieldValue('chairmanReport', parsedData['è²³ã€ä¸»å¸­å ±å‘Š']);
                        setFieldValue('lastMeetingFollowUp', parsedData['åƒã€ä¸Šæ¬¡æœƒè­°è¿½è¹¤äº‹é …']);
                        setFieldValue('currentMeetingDiscussion', parsedData['è‚†ã€æœ¬æ¬¡æœƒè­°å ±å‘ŠåŠè¨è«–äº‹é …']);
                        setFieldValue('adHocMotion', parsedData['ä¼ã€è‡¨æ™‚å‹•è­°']);
                        setFieldValue('nextMeetingFollowUp', parsedData['é™¸ã€ä¸‹æ¬¡æœƒè­°è¿½è¹¤äº‹é …']);
                        setFieldValue('chairmanConclusion', parsedData['æŸ’ã€ä¸»å¸­çµè«–']);

                        setFieldValue('attachmentName', parsedData['é™„ä»¶åç¨±']);

                        showMessage('æª”æ¡ˆè§£ææˆåŠŸï¼Œè³‡æ–™å·²å¡«å…¥è¡¨å–®ï¼', 'success');
                    } else {
                        showMessage('è§£æå¤±æ•—: ' + (result.message || 'ç„¡æ³•å¾æª”æ¡ˆä¸­è§£æåˆ°è³‡æ–™'), 'error');
                    }
                } catch (error) {
                    showMessage('è§£ææª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æˆ–æ§åˆ¶å°ã€‚', 'error');
                    console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                } finally {
                    parseFileButton.disabled = false;
                    parseFileButton.textContent = 'è§£ææª”æ¡ˆ';
                }
            });

            form.addEventListener('submit', (event) => {
                submitForm(event, APPS_SCRIPT_WEB_APP_URL);
            });

            deleteButton.addEventListener('click', () => {
                showDeleteConfirm(async (isConfirmed) => {
                    if (!isConfirmed) return;
                    showMessage('æ­£åœ¨åˆªé™¤è³‡æ–™ä¸­...', 'info', 0);
                    try {
                        const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                            method: 'POST',
                            body: new URLSearchParams({
                                action: 'deleteRecord',
                                rowIndex: rowIndexInput.value
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            showMessage('æœƒè­°ç´€éŒ„å·²æˆåŠŸåˆªé™¤ï¼', 'success');
                            setTimeout(() => {
                               try { window.location.href = 'index.html'; } 
                               catch (e) { console.warn('ç„¡æ³•å°èˆª:', e); }
                            }, 2000);
                        } else {
                            showMessage('åˆªé™¤å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                        }
                    } catch (error) {
                        showMessage('ç¶²è·¯éŒ¯èª¤æˆ– Apps Script ç™¼ç”Ÿå•é¡Œã€‚', 'error');
                        console.error('åˆªé™¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    }
                });
            });

            noMeetingCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    contentFields.classList.add('hidden');
                    startTimeInput.required = false;
                    endTimeInput.required = false;
                } else {
                    contentFields.classList.remove('hidden');
                    startTimeInput.required = true;
                    endTimeInput.required = true;
                }
            });
        });
    </script>
</body>
</html>
